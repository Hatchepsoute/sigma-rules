# Generic Incident Response Playbook (YAML)
# CVE-2026-20952 - Microsoft Office (Use-After-Free) - Suspicious Child Process Execution (STRICT)
#
# Purpose:
# - Provide a SIEM/SOAR-agnostic playbook that SOC teams can adapt to their tooling.
# - Triggered by the Sigma STRICT rule detecting Office spawning suspicious command/script engines.
#
# References:
# - MSRC: https://msrc.microsoft.com/update-guide/vulnerability/CVE-2026-20952
# - NVD : https://nvd.nist.gov/vuln/detail/CVE-2026-20952

playbook:
  name: "CVE-2026-20952 - Microsoft Office UAF (STRICT)"
  id: "playbook-cve-2026-20952-generic-v1"
  version: "1.0.0"
  status: "stable"
  created: "2026-01-15"
  owner: "SOC"
  severity_default: "high"
  confidence_default: "high"

  trigger:
    type: "detection"
    source: "SIEM"
    rule_name: "Microsoft Office Suspicious Child Process Execution (STRICT)"
    log_requirements:
      - "Process creation telemetry (Sysmon EventID 1 or EDR equivalent)"
    required_fields:
      - "ParentImage"
      - "Image"
      - "CommandLine"
      - "User"
      - "Hostname"
      - "EventTime"

  objectives:
    - "Validate whether execution is malicious or legitimate automation."
    - "Contain potential compromise quickly (stop spread / prevent data loss)."
    - "Collect artefacts for root-cause analysis and threat hunting."
    - "Remediate by patching and hardening Office execution paths."

  roles:
    l1:
      responsibilities:
        - "Initial triage and validation"
        - "Gather basic context and artefacts"
        - "Escalate based on decision table"
    l2:
      responsibilities:
        - "Deep investigation and correlation"
        - "Containment actions (isolation / kill process)"
        - "Coordinate with IT for patching"
    l3_ir:
      responsibilities:
        - "Forensic acquisition and scope assessment"
        - "Eradication and recovery coordination"
        - "Post-incident improvements"

  workflow:
    - phase: "Triage (L1)"
      steps:
        - id: "T1"
          action: "Validate parent/child relationship"
          checks:
            - "ParentImage endswith: WINWORD.EXE / EXCEL.EXE / POWERPNT.EXE / OUTLOOK.EXE / MSACCESS.EXE"
            - "Child Image is one of: powershell.exe, pwsh.exe, cmd.exe, mshta.exe, rundll32.exe, wscript.exe, cscript.exe"
          output:
            - "validated_parent_child: true|false"
        - id: "T2"
          action: "Review command-line for malicious patterns"
          checks:
            - "Contains: -enc / EncodedCommand / FromBase64String / IEX / Invoke-Expression"
            - "Contains: DownloadString / http(s):// / javascript: / vbscript: / .dll,"
          output:
            - "suspicious_args: true|false"
        - id: "T3"
          action: "Fast false-positive screening"
          checks:
            - "ParentCommandLine contains: /automation OR /pt OR /embedding"
            - "User is known service account or Office automation account (if applicable)"
          output:
            - "likely_fp: true|false"
      exit_criteria:
        - "If validated_parent_child=false -> close as FP/noise"
        - "If likely_fp=true and business owner confirms -> close as FP with allowlist request"
        - "Else -> escalate to Investigation (L2)"

    - phase: "Investigation (L2)"
      steps:
        - id: "I1"
          action: "Collect host context"
          tasks:
            - "Identify logged-on sessions and recent logons"
            - "Check recent Office document opened/downloaded (where available)"
            - "Inspect process tree (parent, grandparent, siblings)"
          artefacts:
            - "process_tree"
            - "recent_files"
            - "user_session_details"
        - id: "I2"
          action: "Correlate with network activity"
          data_sources:
            - "EDR network telemetry"
            - "Sysmon EventID 3 (if available)"
            - "Proxy/Firewall logs"
          checks:
            - "Outbound HTTP/S to unknown or rare destinations"
            - "Connections shortly after Office spawned child process"
          output:
            - "external_egress: true|false"
        - id: "I3"
          action: "EDR/AV/AMSI signal check"
          checks:
            - "AMSI alerts triggered by PowerShell content"
            - "EDR detections for LOLBins abuse"
            - "Defender/AV detections linked to Office content"
          output:
            - "edr_signal: none|low|medium|high"
        - id: "I4"
          action: "Scope assessment"
          checks:
            - "Search for same pattern across environment (same command line / same parent)"
            - "Identify other endpoints with Office -> LOLBin execution in last 24-72h"
          output:
            - "scope: single|multiple"

      exit_criteria:
        - "If suspicious_args=true AND (external_egress=true OR edr_signal in [medium,high]) -> proceed to Containment"
        - "If suspicious_args=true but no supporting signals -> consider 'suspicious' and proceed to targeted hunting"
        - "If evidence indicates legitimate automation -> document and close with tuning request"

    - phase: "Containment (L2/L3)"
      steps:
        - id: "C1"
          action: "Endpoint containment"
          actions:
            - "Isolate endpoint from network (EDR isolation)"
            - "Terminate malicious child process (if safe)"
            - "Block outbound destinations (proxy/firewall) when confirmed malicious"
          output:
            - "contained: true|false"
        - id: "C2"
          action: "Preserve evidence"
          actions:
            - "Collect command line, hashes, parent/child process metadata"
            - "Acquire memory snapshot (if IR workflow allows)"
            - "Collect relevant documents (quarantine) and email artefacts (if applicable)"
          output:
            - "evidence_collected: true|false"

    - phase: "Eradication & Recovery (L3/IT)"
      steps:
        - id: "E1"
          action: "Patch and harden"
          actions:
            - "Apply Office security updates (CVE-2026-20952)"
            - "Enable/validate ASR rules for Office child-process creation (where applicable)"
            - "Restrict Office from launching child processes via policy (where feasible)"
        - id: "E2"
          action: "Credential hygiene"
          actions:
            - "Reset credentials if signs of credential access/exfiltration"
            - "Review privileged sessions on affected host(s)"
        - id: "E3"
          action: "Recovery"
          actions:
            - "Reimage/restore if integrity cannot be ensured"
            - "Monitor endpoint for 72h post-recovery"

    - phase: "Post-Incident"
      steps:
        - id: "P1"
          action: "Detection tuning"
          actions:
            - "Add allowlist for confirmed benign automation patterns (strictly scoped)"
            - "Create correlation rule (Office -> LOLBin -> network egress)"
        - id: "P2"
          action: "Threat hunting"
          actions:
            - "Hunt for similar Office spawn patterns across environment"
            - "Search for encoded PowerShell and mshta usage near Office events"
        - id: "P3"
          action: "Reporting"
          actions:
            - "Document timeline, IOCs, TTPs (MITRE ATT&CK mapping)"
            - "Capture lessons learned and preventive controls"

  decision_logic:
    # Simple operational decision model aligned with SOC tiers.
    - if: "likely_fp == true"
      then: "Close as FP after business validation; create tuning ticket"
    - if: "suspicious_args == true and (external_egress == true or edr_signal in ['medium','high'])"
      then: "Declare incident; isolate host; escalate to IR"
    - if: "suspicious_args == true"
      then: "Mark as suspicious; perform environment-wide hunting; monitor"
    - else: "Close as informational; keep for hunting metrics"

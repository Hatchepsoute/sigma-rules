# Playbook SOAR générique (YAML) - CVE-2026-20947 SharePoint RCE
# Ce playbook est agnostique SIEM/SOAR et peut être adapté à TheHive, Cortex, XSOAR, Sentinel, Wazuh, OpenSearch, etc.

playbook:
  name: "CVE-2026-20947 SharePoint RCE - Attack → Detection → Response"
  id: "PB-CVE-2026-20947-FR"
  version: "1.0"
  status: "experimental"
  created: "2026-01-30"
  author: "Adama ASSIONGBON"
  description: >
    Playbook générique de réponse à incident pour une RCE Microsoft SharePoint liée à CVE-2026-20947.  Inclut un volet hunting Web (early warning) et une confirmation d’impact côté hôte (haute confiance).
  references:
    - "https://nvd.nist.gov/vuln/detail/CVE-2026-20947"
    - "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2026-20947"
    - "https://windowsforum.com/threads/cve-2026-20947-patch-and-hunt-for-sharepoint-server-rce-jan-2026.396820/"
  detections:
    - name: "HTTP Early Warning (HUNTING)"
      sigma_rule: "rules/web/sharepoint_rce_cve-2026-20947_http.yml"
      expected_sources:
        - "Logs IIS w3svc"
        - "Logs WAF / Reverse proxy (après conversion)"
      severity: "high"
    - name: "Windows Process Impact (STRICT)"
      sigma_rule: "rules/windows/sharepoint_rce_cve-2026-20947_process.yml"
      expected_sources:
        - "Windows Security 4688"
        - "Sysmon Event ID 1"
        - "Télémétrie process EDR/XDR"
      severity: "critical"

  inputs:
    required:
      - case_id
      - host
      - alert_time_utc
      - alert_type   # http_hunting | process_strict | both
    optional:
      - source_ip
      - user
      - uri
      - http_status
      - commandline
      - parent_image
      - child_image
      - siem_query_link
      - edr_alert_link

  outputs:
    - "validated_true_positive (boolean)"
    - "confidence (low|medium|high)"
    - "scope (single_host|multi_host|unknown)"
    - "ioc_list (ips/domains/urls/hashes)"
    - "containment_actions_taken (list)"
    - "eradication_actions_taken (list)"
    - "recovery_actions_taken (list)"
    - "lessons_learned (text)"

  workflow:
    - phase: "1. Prise en charge & qualification"
      objective: "Valider le contexte, le périmètre et l’urgence."
      tasks:
        - id: "T1"
          name: "Collecter le contexte d’alerte"
          actions:
            - "Capturer les événements bruts : HTTP + process creation (si disponibles)."
            - "Extraire : host, user, source_ip, uri, http_status, parent/enfant, commandline."
          evidence:
            - "raw_event_http"
            - "raw_event_process"
        - id: "T2"
          name: "Qualifier le type de déclencheur"
          decision:
            when:
              - condition: "alert_type == process_strict"
                next: "2. Investigation haute confiance"
              - condition: "alert_type == http_hunting"
                next: "2. Investigation early warning"
              - condition: "alert_type == both"
                next: "2. Investigation haute confiance"
            default_next: "2. Investigation early warning"

    - phase: "2. Investigation early warning"
      objective: "Évaluer si l’activité HTTP indique une tentative d’exploitation active."
      tasks:
        - id: "T3"
          name: "Vérifier exposition & patch"
          actions:
            - "Confirmer si SharePoint est exposé Internet (VIP publique, reverse proxy, WAF)."
            - "Vérifier le CU / correctif de sécurité SharePoint (Jan 2026)."
            - "Vérifier la présence d’une fenêtre de maintenance."
        - id: "T4"
          name: "Chasser la répétition et d’autres cibles"
          actions:
            - "Rechercher la même source_ip sur d’autres serveurs SharePoint."
            - "Rechercher des tentatives répétées (URIs/queries) dans ±30 minutes."
          outcomes:
            - "Si multiples tentatives/cibles : augmenter la priorité et notifier le lead IR."
        - id: "T5"
          name: "Pivot vers la télémétrie hôte"
          actions:
            - "Sur le serveur, chercher w3wp.exe / OWSTIMER.EXE → cmd/powershell dans ±10 minutes."
            - "Rechercher des fichiers nouveaux/modifiés sous inetpub/wwwroot et répertoires SharePoint."

    - phase: "2. Investigation haute confiance"
      objective: "Confirmer une exploitation réussie / impact RCE."
      tasks:
        - id: "T6"
          name: "Valider la chaîne de processus"
          actions:
            - "Confirmer parent : w3wp.exe ou OWSTIMER.EXE."
            - "Analyser la commandline : EncodedCommand, IEX, DownloadString, certutil/bitsadmin/mshta."
            - "Vérifier le contexte : user, intégrité, répertoire de travail."
        - id: "T7"
          name: "Chercher payload et persistance"
          actions:
            - "Chasser les webshells : nouveaux fichiers ASPX dans les répertoires web."
            - "Contrôler tâches planifiées/services créés autour de l’heure."
            - "Contrôler connexions sortantes suspectes depuis le serveur SharePoint."
        - id: "T8"
          name: "Décider sévérité & confiance"
          decision:
            when:
              - condition: "strong_indicators_present == true"
                set:
                  confidence: "high"
                  validated_true_positive: true
                  next: "3. Confinement"
              - condition: "maintenance_window == true and known_admin_script == true"
                set:
                  confidence: "medium"
                  validated_true_positive: false
                  next: "7. Leçons apprises"
            default_set:
              confidence: "medium"
              validated_true_positive: "unknown"
            default_next: "3. Confinement"

    - phase: "3. Confinement"
      objective: "Stopper l’activité de l’attaquant et éviter la propagation."
      tasks:
        - id: "T9"
          name: "Isoler l’hôte (si confirmé/fort soupçon)"
          actions:
            - "Confinement réseau via EDR (préféré) OU isolement VLAN via firewall."
            - "Bloquer la source_ip sur WAF/Reverse proxy/Firewall."
        - id: "T10"
          name: "Confinement des comptes"
          actions:
            - "Désactiver/réinitialiser les comptes suspectés compromis."
            - "Rotation des comptes de service si compromission suspectée."
      exit_criteria:
        - "Hôte isolé ou déclaré sain."
        - "Source bloquée si malveillante."

    - phase: "4. Éradication"
      objective: "Supprimer les artefacts et corriger la vulnérabilité."
      tasks:
        - id: "T11"
          name: "Supprimer les artefacts"
          actions:
            - "Supprimer webshells/scripts malveillants identifiés."
            - "Retirer tâches planifiées/services non autorisés."
            - "Mettre en quarantaine binaires via EDR."
        - id: "T12"
          name: "Patch"
          actions:
            - "Appliquer le correctif/CU SharePoint corrigeant CVE-2026-20947."
            - "Redémarrer les services si nécessaire et valider l’état applicatif."

    - phase: "5. Rétablissement"
      objective: "Revenir à la normale avec supervision renforcée."
      tasks:
        - id: "T13"
          name: "Restaurer & valider"
          actions:
            - "Restaurer depuis une sauvegarde saine si nécessaire."
            - "Valider app pools IIS, services SharePoint, et accès utilisateur."
        - id: "T14"
          name: "Surveillance 72h"
          actions:
            - "Surveiller process creation (w3wp/OWSTIMER) et trafic sortant."
            - "Surveiller les logs IIS (requêtes suspectes persistantes)."

    - phase: "6. Communication & reporting"
      objective: "Notifier et documenter."
      tasks:
        - id: "T15"
          name: "Notification des parties prenantes"
          actions:
            - "Notifier IT/SharePoint owners, lead IR, management selon sévérité."
        - id: "T16"
          name: "Documentation de cas"
          actions:
            - "Joindre preuves, timeline, IoCs, remédiations."
            - "Tracer décisions et exceptions/tuning (si applicable)."

    - phase: "7. Leçons apprises & amélioration détection"
      objective: "Améliorer les règles et réduire le risque."
      tasks:
        - id: "T17"
          name: "Tuning des règles Sigma"
          actions:
            - "Ajouter comptes maintenance et chemins scripts connus dans les filtres (réduction FP)."
            - "Corrélation recommandée : HTTP early-warning + Process STRICT dans 5–10 minutes."
        - id: "T18"
          name: "Durcissement préventif"
          actions:
            - "Restreindre endpoints admin, forcer MFA, réduire exposition, renforcer WAF."
            - "Revoir SLA patch management pour services exposés Internet."

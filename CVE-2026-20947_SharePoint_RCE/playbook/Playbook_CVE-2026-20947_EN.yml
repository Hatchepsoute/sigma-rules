# Generic SOAR Playbook (YAML) - CVE-2026-20947 SharePoint RCE
# This playbook is SIEM/SOAR agnostic and can be adapted to TheHive, Cortex, XSOAR, Sentinel, Wazuh, OpenSearch, etc.

playbook:
  name: "CVE-2026-20947 SharePoint RCE - Attack → Detection → Response"
  id: "PB-CVE-2026-20947-EN"
  version: "1.0"
  status: "experimental"
  created: "2026-01-30"
  author: "SOC/CTI Community"
  description: >
    Generic incident response playbook for Microsoft SharePoint Server RCE related to CVE-2026-20947.
    Includes early-warning web hunting and high-confidence host impact confirmation.
  references:
    - "https://nvd.nist.gov/vuln/detail/CVE-2026-20947"
    - "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2026-20947"
    - "https://windowsforum.com/threads/cve-2026-20947-patch-and-hunt-for-sharepoint-server-rce-jan-2026.396820/"
  detections:
    - name: "HTTP Early Warning (HUNTING)"
      sigma_rule: "rules/web/sharepoint_rce_cve-2026-20947_http.yml"
      expected_sources:
        - "IIS w3svc logs"
        - "WAF / Reverse proxy logs (after conversion)"
      severity: "high"
    - name: "Windows Process Impact (STRICT)"
      sigma_rule: "rules/windows/sharepoint_rce_cve-2026-20947_process.yml"
      expected_sources:
        - "Windows Security 4688"
        - "Sysmon Event ID 1"
        - "EDR/XDR process telemetry"
      severity: "critical"

  inputs:
    required:
      - case_id
      - host
      - alert_time_utc
      - alert_type   # http_hunting | process_strict | both
    optional:
      - source_ip
      - user
      - uri
      - http_status
      - commandline
      - parent_image
      - child_image
      - siem_query_link
      - edr_alert_link

  outputs:
    - "validated_true_positive (boolean)"
    - "confidence (low|medium|high)"
    - "scope (single_host|multi_host|unknown)"
    - "ioc_list (ips/domains/urls/hashes)"
    - "containment_actions_taken (list)"
    - "eradication_actions_taken (list)"
    - "recovery_actions_taken (list)"
    - "lessons_learned (text)"

  workflow:
    - phase: "1. Intake & Classification"
      objective: "Validate alert context, scope, and urgency."
      tasks:
        - id: "T1"
          name: "Collect alert context"
          actions:
            - "Capture full raw event(s): HTTP + Process creation (if available)."
            - "Extract key fields: host, user, source_ip, uri, http_status, parent/child process, commandline."
          evidence:
            - "raw_event_http"
            - "raw_event_process"
        - id: "T2"
          name: "Classify trigger type"
          decision:
            when:
              - condition: "alert_type == process_strict"
                next: "2. High-Confidence Investigation"
              - condition: "alert_type == http_hunting"
                next: "2. Early-Warning Investigation"
              - condition: "alert_type == both"
                next: "2. High-Confidence Investigation"
            default_next: "2. Early-Warning Investigation"

    - phase: "2. Early-Warning Investigation"
      objective: "Assess whether HTTP activity indicates an active exploit attempt."
      tasks:
        - id: "T3"
          name: "Check exposure & patch status"
          actions:
            - "Confirm if SharePoint is Internet-facing (public VIP, reverse proxy, WAF)."
            - "Verify SharePoint CU / security update status for Jan 2026."
            - "Confirm maintenance window overlap."
        - id: "T4"
          name: "Hunt for repetition and lateral targets"
          actions:
            - "Search for same source_ip against other SharePoint servers."
            - "Search for repeated suspicious URIs/queries within ±30 minutes."
          outcomes:
            - "If repeated attempts or multiple targets: increase priority and notify IR lead."
        - id: "T5"
          name: "Pivot to host telemetry"
          actions:
            - "On the target server, search for w3wp.exe / OWSTIMER.EXE spawning cmd/powershell within ±10 minutes."
            - "Search for new/modified files under inetpub/wwwroot and SharePoint directories."

    - phase: "2. High-Confidence Investigation"
      objective: "Confirm successful exploitation / RCE impact."
      tasks:
        - id: "T6"
          name: "Validate process chain"
          actions:
            - "Confirm parent is w3wp.exe or OWSTIMER.EXE."
            - "Review full commandline for strong indicators: EncodedCommand, IEX, DownloadString, certutil/bitsadmin/mshta."
            - "Check execution context: user, integrity, working directory."
        - id: "T7"
          name: "Search for payload and persistence"
          actions:
            - "Hunt for webshells: new ASPX files in web directories."
            - "Check scheduled tasks/services created around alert time."
            - "Check suspicious outbound connections from SharePoint server."
        - id: "T8"
          name: "Decide severity & confidence"
          decision:
            when:
              - condition: "strong_indicators_present == true"
                set:
                  confidence: "high"
                  validated_true_positive: true
                  next: "3. Containment"
              - condition: "maintenance_window == true and known_admin_script == true"
                set:
                  confidence: "medium"
                  validated_true_positive: false
                  next: "7. Lessons Learned"
            default_set:
              confidence: "medium"
              validated_true_positive: "unknown"
            default_next: "3. Containment"

    - phase: "3. Containment"
      objective: "Stop attacker activity and prevent spread."
      tasks:
        - id: "T9"
          name: "Isolate host (if confirmed/high suspicion)"
          actions:
            - "EDR network containment (preferred) OR firewall isolate VLAN."
            - "Block source_ip at WAF/Reverse proxy/Firewall."
        - id: "T10"
          name: "Account containment"
          actions:
            - "Disable/reset suspected compromised accounts."
            - "Rotate service account credentials if signs of compromise."
      exit_criteria:
        - "Host isolated or confirmed safe."
        - "Source blocked if malicious."

    - phase: "4. Eradication"
      objective: "Remove attacker artifacts and close the vulnerability."
      tasks:
        - id: "T11"
          name: "Remove artifacts"
          actions:
            - "Delete identified webshells/malicious scripts."
            - "Remove unauthorized scheduled tasks/services."
            - "Quarantine malware/binaries via EDR."
        - id: "T12"
          name: "Patch"
          actions:
            - "Apply SharePoint security update/CU addressing CVE-2026-20947."
            - "Restart services as required and validate application health."

    - phase: "5. Recovery"
      objective: "Restore normal operations with heightened monitoring."
      tasks:
        - id: "T13"
          name: "Restore & validate"
          actions:
            - "Restore from clean backup if needed."
            - "Validate SharePoint app pools, search, timer services, and user access."
        - id: "T14"
          name: "72h monitoring"
          actions:
            - "Monitor process creation (w3wp/OWSTIMER) and outbound traffic."
            - "Monitor IIS logs for continued suspicious queries."

    - phase: "6. Communication & Reporting"
      objective: "Notify stakeholders and document actions."
      tasks:
        - id: "T15"
          name: "Stakeholder notification"
          actions:
            - "Notify IT/SharePoint owners, IR lead, and management based on severity."
        - id: "T16"
          name: "Case documentation"
          actions:
            - "Attach evidence, timeline, IoCs, and remediation steps."
            - "Record decisions and tuning exceptions (if any)."

    - phase: "7. Lessons Learned & Detection Improvement"
      objective: "Improve detections and reduce future risk."
      tasks:
        - id: "T17"
          name: "Tune Sigma rules"
          actions:
            - "Add known maintenance accounts and script paths to filters (reduce false positives)."
            - "Consider correlation: HTTP early-warning + Process STRICT within 5–10 minutes."
        - id: "T18"
          name: "Preventive hardening"
          actions:
            - "Restrict SharePoint admin endpoints, enforce MFA, limit exposure, strengthen WAF rules."
            - "Review patch management SLA for Internet-facing services."

# ðŸ TheHive Playbook (YAML) - CVE-2025-62221 (Kernel EoP USER âžœ SYSTEM)
# Date: 2025-12-22
#
# âš ï¸ Practical note:
# - TheHive natively manages Case Templates via UI/API (commonly JSON).
# - This YAML file is provided as a SOARâ€‘ready, humanâ€‘readable format
#   easily convertible to JSON or directly translatable into TheHive tasks.
#
# âœ… Recommended usage:
# - Create a Case Template "CVE-2025-62221 - Kernel EoP" in TheHive
# - Reproduce the stages and tasks below
# - Connect responders/analysers (Cortex / EDR / IAM) according to your environment

playbook:
  name: "CVE-2025-62221 - Kernel EoP (USER âžœ SYSTEM)"
  tlp: "AMBER"
  pap: "AMBER"
  severity: 3   # 1=low, 2=medium, 3=high, 4=critical (adapt to internal mapping)
  status: "Open"
  tags:
    - "cve-2025-62221"
    - "windows"
    - "kernel-eop"
    - "privilege-escalation"
    - "sigma"
    - "patch-tuesday"
  description: >
    SOC workflow to qualify and respond to an abnormal privilege escalation
    (USER âžœ SYSTEM) potentially related to CVE-2025-62221 (cldflt.sys).
  trigger:
    source: "SIEM/Sigma"
    condition: "IntegrityLevel=System AND ParentImage in user-writable path AND ChildImage in LOLBin/shell set"
    expected_fields:
      - hostname
      - user
      - parent_image
      - child_image
      - command_line
      - timestamp
      - process_guid
      - parent_process_guid
      - source (sysmon/edr)

  stages:
    - name: "L1 â€” Triage"
      owner: "SOC-L1"
      sla_minutes: 15
      tasks:
        - title: "Validate signal (Sigma rule)"
          description: >
            Confirm: IntegrityLevel=System, parent in user-writable path (Users/AppData/Temp/Downloads),
            child = cmd/powershell/rundll32/regsvr32. Extract the process tree.
          type: "investigation"
          required_artifacts:
            - process_tree
            - parent_image
            - child_image
            - command_line
        - title: "Check asset context & maintenance window"
          description: >
            Identify asset type (workstation/server), criticality, planned maintenance,
            and any legitimate IT tooling.
          type: "enrichment"
          required_artifacts:
            - asset_context
            - maintenance_window
        - title: "Quick false positive assessment"
          description: >
            FP indicators: known installer/updater, MDM/EDR tooling, signed and expected binaries.
            If obvious FP: document and propose tuning.
          type: "decision"
          decision:
            if_true: "Close as False Positive"
            if_false: "Escalate to L2"

    - name: "L2 - Qualification"
      owner: "SOC-L2"
      sla_minutes: 60
      tasks:
        - title: "Process chain & privilege escalation analysis"
          description: >
            Confirm USER âžœ SYSTEM transition and identify the first executable from a user-writable path.
            Look for anomalies (unknown parent, encoded command line, LOLBins).
          type: "investigation"
          outputs:
            - user_to_system_validation: ["confirmed","unconfirmed"]
            - suspected_payload_path
        - title: "Post-escalation hunting (Â±15 min)"
          description: >
            Hunt for post-exploit activity: service creation (sc.exe), scheduled tasks (schtasks),
            registry persistence, LSASS access, dumping, security tampering, outbound connections.
          type: "hunting"
          queries:
            - "ProcessCreation: sc.exe OR schtasks.exe OR reg.exe (persistence keys)"
            - "Security: LSASS access / credential dumping indicators (EDR/Sysmon)"
            - "Network: suspicious outbound connections after escalation"
          outputs:
            - post_exploitation_found: ["yes","no"]
            - iocs: []
        - title: "Incident decision"
          description: >
            If escalation confirmed + post-exploitation OR suspicious parent/payload â‡’ probable incident.
            Otherwise: confirmed FP + tuning.
          type: "decision"
          decision:
            if_incident: "Proceed to Containment"
            if_false_positive: "Close as False Positive (tuned)"

    - name: "L2/L3 - Containment"
      owner: "SOC-L3"
      sla_minutes: 30
      tasks:
        - title: "Isolate host (EDR/NAC)"
          description: "Isolate the workstation/server from the network (forensic channel only)."
          type: "response"
          responders:
            - name: "EDR_Isolate_Host"
              enabled: false
              params:
                hostname: "{hostname}"
        - title: "Disable / force reset of user account"
          description: "Suspend the account if risk is high, force password reset if required."
          type: "response"
          responders:
            - name: "IAM_Disable_User"
              enabled: false
              params:
                user: "{user}"
        - title: "Preserve evidence"
          description: >
            Collect: process tree, logs, disk artifacts (payload), memory if possible,
            hashes, timeline. Maintain chain of custody.
          type: "forensics"
          outputs:
            - evidence_bundle_ref

    - name: "Remediation"
      owner: "SOC-L3"
      sla_hours: 24
      tasks:
        - title: "Patch CVE-2025-62221"
          description: "Apply Microsoft security updates on exposed hosts."
          type: "remediation"
        - title: "Eradication & hardening"
          description: >
            Remove persistence, clean artifacts, validate system integrity,
            harden controls on user-writable paths, review permissions.
          type: "remediation"
        - title: "Identity reset & privilege review"
          description: "Reset passwords, review local/domain admin accounts and active sessions."
          type: "identity"

    - name: "Post-Incident"
      owner: "SOC-L2"
      sla_hours: 48
      tasks:
        - title: "Tuning & complementary detections"
          description: >
            Adjust exclusions (IT tools), add correlations (LSASS, services, scheduled tasks),
            document IOCs/TTPs and update the pack.
          type: "improvement"
        - title: "Reporting"
          description: "Produce technical summary and recommendations for stakeholders."
          type: "reporting"

  closure:
    outcomes:
      - "False Positive"
      - "True Positive (No Impact)"
      - "True Positive (Impact Confirmed)"
    required_fields:
      - root_cause
      - timeline_summary
      - actions_taken
      - recommendations

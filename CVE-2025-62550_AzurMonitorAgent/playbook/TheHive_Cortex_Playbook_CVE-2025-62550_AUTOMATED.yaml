# TheHive + Cortex Automated Playbook
# Title: CVE-2025-62550 – Azure Monitor Agent Suspicious Child Process (AUTOMATED)
# Purpose: Automated enrichment + decision gate + containment actions
# Author: Adama Assiongbon
# Last Update: 2025-12-24
#
# Notes:
# - This is a generic, automation-ready template. Adapt analyzer/responder names
#   to your Cortex catalog and EDR/firewall tooling.
# - Trigger should be wired to the Sigma rule(s) you deploy (BROAD/STRICT).

playbook:
  name: CVE-2025-62550_AzureMonitorAgent_AUTOMATED
  description: >
    Automated SOC response for suspicious Azure Monitor Agent (AMA) child process activity
    potentially related to CVE-2025-62550. Performs enrichment, scoring, and optional containment.
  version: 1.0
  severity: high
  tlp: amber

  trigger:
    type: alert
    source: SIEM
    match:
      any:
        - rule_name: CVE-2025-62550_AzureMonitorAgent_Suspicious_Child_Process_Spawn
        - rule_name: CVE-2025-62550_AzureMonitorAgent_LOLBin_Download_Execute

  variables:
    # Map these from your SIEM fields at ingestion time
    hostname: "{{alert.hostname}}"
    user: "{{alert.user}}"
    parent_process: "{{alert.parent_process}}"
    child_process: "{{alert.child_process}}"
    command_line: "{{alert.command_line}}"
    src_ip: "{{alert.src_ip}}"
    dst_ip: "{{alert.dst_ip}}"
    dst_domain: "{{alert.dst_domain}}"
    sha256: "{{alert.sha256}}"

  automation:
    enabled: true

  steps:
    - id: case_init
      name: Create Case & Tagging
      actions:
        - create_case:
            title: "CVE-2025-62550 – AMA suspicious child process on {{hostname}}"
            severity: high
            tags:
              - cve-2025-62550
              - azure-monitor-agent
              - post-exploitation
        - add_observable:
            type: hostname
            value: "{{hostname}}"
        - add_observable:
            type: user
            value: "{{user}}"
        - add_observable:
            type: ip
            value: "{{src_ip}}"
        - add_observable:
            type: ip
            value: "{{dst_ip}}"
        - add_observable:
            type: domain
            value: "{{dst_domain}}"
        - add_observable:
            type: hash
            value: "{{sha256}}"

    - id: enrich_process_tree
      name: Enrich Process Tree (Cortex)
      cortex:
        analyzers:
          - name: ProcessTree
            target: "{{hostname}}"
            data:
              parent: "{{parent_process}}"
              child: "{{child_process}}"
              command_line: "{{command_line}}"

    - id: enrich_iocs
      name: Enrich IOCs (Cortex)
      cortex:
        analyzers:
          - name: VirusTotal_GetReport
            when: "{{sha256}}"
            target: "{{sha256}}"
          - name: VirusTotal_GetIPReport
            when: "{{dst_ip}}"
            target: "{{dst_ip}}"
          - name: VirusTotal_GetDomainReport
            when: "{{dst_domain}}"
            target: "{{dst_domain}}"

    - id: classify_cli
      name: Command Line Classification (Cortex)
      cortex:
        analyzers:
          - name: Regex_Command_Detection
            target: "{{command_line}}"
            data:
              patterns:
                - '(?i)\b(iwr|invoke-webrequest|curl|wget|bitsadmin|certutil)\b'
                - '(?i)\b(powershell|pwsh)\b.*\-(enc|encodedcommand)\b'
                - '(?i)\b(mshta|rundll32|regsvr32)\b'
                - '(?i)https?://'
      output:
        set:
          suspicious_cli: "{{analysis.Regex_Command_Detection.matched}}"

    - id: scoring
      name: Risk Scoring Gate
      actions:
        - set_variable:
            name: risk_score
            value: 0
        - add_score_if:
            condition: "{{child_process}} matches '(?i)(cmd\.exe|powershell\.exe|pwsh\.exe|wscript\.exe|cscript\.exe|mshta\.exe|rundll32\.exe)'"
            score: 30
        - add_score_if:
            condition: "{{suspicious_cli}} == true"
            score: 40
        - add_score_if:
            condition: "{{dst_ip}} not empty or {{dst_domain}} not empty"
            score: 20
        - add_score_if:
            condition: "{{sha256}} not empty"
            score: 10

    - id: decision_gate
      name: Automated Decision
      condition:
        if:
          - '{{risk_score}} >= 70'
      actions:
        - set_case_severity: critical
        - add_tag: confirmed_malicious
        - add_comment: "Risk score >= 70. Treat as confirmed malicious AMA child process activity."
      else_actions:
        - add_tag: needs_review
        - add_comment: "Risk score < 70. Analyst validation required."

    - id: containment
      name: Automated Containment (Responders)
      condition:
        if_tag_present: confirmed_malicious
      cortex:
        responders:
          - name: EDR_IsolateHost
            target: "{{hostname}}"
          - name: Firewall_BlockIP
            when: "{{dst_ip}}"
            target: "{{dst_ip}}"
          - name: Disable_User_Account
            when: "{{user}}"
            target: "{{user}}"

    - id: notification
      name: Notify SOC / Cloud Team
      actions:
        - notify:
            channel: soc
            message: "CVE-2025-62550: {{hostname}} – AMA spawned {{child_process}} ({{risk_score}}). Tags: {{case.tags}}"
        - notify:
            channel: cloud
            message: "Review AMA configuration/updates on {{hostname}}. Potential CVE-2025-62550 exploitation chain."

    - id: closure
      name: Close or Escalate
      condition:
        if_tag_present: needs_review
      actions:
        - add_task: "Analyst review required: validate developer/admin actions, check AMA logs, confirm network activity."
        - keep_case_open: true
